<html>
<head>
  <meta http-equiv="refresh" content="3600">
  <title>Le Chateau Pink</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.1/angular.min.js"
          integrity="sha256-3SrLjPeRPa1ofM280r+OMcUjJZKLWJHr6SRtRu3dRb0=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"
          integrity="sha256-bFYtqOZj1MLDlOrOlxCU9aruDP2zxiIKvmoo+dHsy4w=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"
          integrity="sha256-8E6QUcFg1KTnpEU8TFGhpTGHw5fJqB9vCms3OhAYLqw=" crossorigin="anonymous"></script>
  <script>
    const mjpeg_proxy = "http://mjpeg.p.cns.me";
    const zwave_url = "http://zwave.p.cns.me";
    const alarm_url = "http://visonic.p.cns.me/";
    const proximity_url = "http://locator.p.cns.me/";
    const wemo_url = "http://192.168.0.3:15000";
  </script>
  <script>
    angular.module('myApp', [])
      .controller('MyController', ['$scope', '$http', '$interval', ($scope, $http, $interval) => {
        $scope.alarmDeviceFilter = (device) => device.subtype == "CONTACT_V" || device.subtype == "SHOCK_CONTACT_AUX_ANTIMASK" || device.subtype == "CONTACT_AUX";

// get cameras
        $http({
          method: 'GET',
          url: mjpeg_proxy
        })
          .then(response =>
            $scope.cameras = _.map(response.data, (cam) => mjpeg_proxy + cam)
          )

        let updatepoll = () => {
// zwave
          $http({
            method: 'GET',
            url: `${zwave_url}/json.htm?type=devices&filter=light&used=true&order=Name&plan=0`
          })
            .then(response => $scope.zwaveDevices = response.data.result)

// alarm status
          $http({
            method: 'GET',
            url: alarm_url
          })
            .then(response => {
              $scope.alarm = response.data.partitions[0];
              $scope.alarm_zones = response.data.zones
            })

// proximity
          $http({
            method: 'GET',
            url: proximity_url
          })
            .then(response =>
              $scope.proximities = response.data
            )
        }
// poll
        updatepoll();
        $interval(updatepoll, 1000)

        // wemo socket
        const socket = io.connect(wemo_url);
        socket.on('connect', () => socket.emit('join', null));
        $scope.wemoDevices = {};
        socket.on("send:devicestate", device =>
          $scope.$apply(() =>
            $scope.wemoDevices[device.serialnumber] = device
          ));
        $scope.cameras = cameras;
      }])


  </script>
</head>
<body ng-app="myApp" ng-controller="MyController">
<main>
  <div id="cameras">
    <img class="webcam" ng-repeat="(k,v) in cameras track by k"
         ng-if="v" ng-src="{{v}}">
  </div>
  <ul id="devices">
    <li class="alarm" ng-class="alarm.state"><strong>Alarm:</strong> {{alarm.state}} {{alarm.ready_status > 0 ?
      "" : "Not-Ready"}}
    </li>
    <li ng-if="proximities.cnsiphone" class="proximity" ng-class="proximities.cnsiphone.present ? 'Home' : 'Away'">
      <strong>Chris:</strong>
      {{proximities.cnsiphone.present ? "Home" :
      proximities.cnsiphone.distance.miles.toFixed(2) + " miles away"}}
    </li>
    <li ng-if="proximities.hnsiphone" class="proximity" ng-class="proximities.hnsiphone.present ? 'Home' : 'Away'">
      <strong>Hannah:</strong>
      {{proximities.hnsiphone.present ? "Home" :
      proximities.hnsiphone.distance.miles.toFixed(2) + " miles away"}}
    </li>
    <li class="alarm-sensors" ng-class="v.troubles[0]"
        ng-repeat="(k,v) in alarm_zones | filter: alarmDeviceFilter track by k"><strong>{{v.location}}:</strong>
      {{v.troubles[0] == "OPENED" ? "Open" : "Closed"}}
    </li>
    <li ng-repeat="(k,v) in zwaveDevices |filter: {Favorite:1} track by k" ng-class="v.Status">
      <strong>{{v.Name}}:</strong>
      {{v.Status}}
    </li>
    <li ng-repeat="(k,v) in wemoDevices track by k" ng-class="v.Status">
      <strong>{{v.name}}:</strong>
      {{v.state === 0 ? "off" : "on"}}
    </li>
  </ul>
</main>
</body>

</body>
<style>
  body {
    margin: 0;
    background: black;
    font-family: Helvetica;
    color: white;
  }

  .webcam {
    display: block;
    float: left;
    width: 49.5%;
    margin-left: 1%;
    -webkit-user-select: none;
  }

  .webcam:first-child {
    margin-left: 0;
  }

  #devices {
    clear: both;
    list-style: none;
    display: block;
    padding: 1em 0 0 0;
    margin: 0;
  }

  #devices li {
    display: block;
    border: 1px #7F7F7F solid;
    float: left;
    margin: 0;
    padding: 1em;
    text-transform: capitalize;
  }

  #devices li.proximity.home,
  #devices li.alarm.disarm {
    background: green;
  }

  #devices li.alarm.arm {
    background: red;
    animation: blinker 1s linear infinite;
  }

  #devices li.proximity.away,
  #devices li.opened,
  #devices li.alarm.home {
    background: #FFBF00;
    animation: blinker 5s linear infinite;
  }

  #devices li.unlocked {
    background: red;
    animation: blinker 1s linear infinite;
  }

  @keyframes blinker {
    50% {
      opacity: 0.5;
    }
  }

</style>
</html>